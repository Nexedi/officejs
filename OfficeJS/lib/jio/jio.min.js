/*! JIO - v0.1.0 - 2012-05-18
* Copyright (c) 2012 Nexedi; Licensed  */
var JIO=function(){var a=function(a,b){var c={jobMethodObject:{checkNameAvailability:{start_event:"start_checkingNameAvailability",stop_event:"stop_checkingNameAvailability",retvalue:"isAvailable"},saveDocument:{start_event:"start_saving",stop_event:"stop_saving",retvalue:"isSaved"},loadDocument:{start_event:"start_loading",stop_event:"stop_loading",retvalue:"fileContent"},getDocumentList:{start_event:"start_gettingList",stop_event:"stop_gettingList",retvalue:"list"},removeDocument:{start_event:"start_removing",stop_event:"stop_removing",retvalue:"isRemoved"}}},d={jobManagingMethod:{canSelect:function(a,b){return JSON.stringify(a.storage)===JSON.stringify(b.storage)&&JSON.stringify(a.applicant)===JSON.stringify(b.applicant)&&a.fileName===b.fileName?!0:!1},canRemoveFailOrDone:function(a,b){return a.status==="fail"||a.status==="done"?!0:!1},canEliminate:function(a,b){return a.status!=="ongoing"&&(a.method==="removeDocument"&&b.method==="saveDocument"||a.method==="saveDocument"&&b.method==="removeDocument")?!0:!1},canReplace:function(a,b){return a.status!=="ongoing"&&a.method===b.method&&a.date<b.date?!0:!1},cannotAccept:function(a,b){if(a.status!=="ongoing"){if(a.method==="removeDocument"&&b.method==="loadDocument")return!0}else{if(a.method===b.method==="loadDocument")return!0;if(a.method==="removeDocument"&&(b.method==="loadDocument"||b.method==="removeDocument"))return!0;if(a.method===b.method==="saveDocument"&&a.fileContent===b.fileContent)return!0;if(a.method===b.method==="getDocumentList"||a.method===b.method==="checkNameAvailability")return!0}return!1},mustWait:function(a,b){return a.method==="getDocumentList"||a.method==="checkNameAvailability"||b.method==="getDocumentList"||b.method==="checkNameAvailability"?!1:!0}},localStorage:null,queueID:1,storageTypeObject:{}},e,f,g,h,i,j,k,l;return e=function(){var a={},c={},d={},e,f;return c.eventAction=function(a){return f=a&&d[a],f||(e=b.Callbacks(),f={publish:e.fire,subscribe:e.add,unsubscribe:e.remove},a&&(d[a]=f)),f},a.publish=function(a,b){c.eventAction(a).publish(b)},a.subscribe=function(a,b){return c.eventAction(a).subscribe(b),b},a.unsubscribe=function(a,b){c.eventAction(a).unsubscribe(b)},a},f=function(a){var c=b.extend({},a);return c.id=0,c.status="initial",c.date=Date.now(),c},g=function(a,e){var g={},h={};return g.init=function(b){var c,d=function(){};b.publisher&&(h.publisher=a),h.jioID=b.jioID,h.jobObjectName="jio/jobObject/"+b.jioID,h.jobObject={},g.copyJobQueueToLocalStorage();for(c in h.recoveredJobObject)h.recoveredJobObject[c].callback=d,g.addJob(h.recoveredJobObject[c])},g.close=function(){JSON.stringify(h.jobObject)==="{}"&&d.localStorage.deleteItem(h.jobObjectName)},g.getNewQueueID=function(){var a=d.localStorage.getAll(),b=0,c="key",e=["splitedkey"];for(c in a)e=c.split("/"),e[0]==="jio"&&e[1]==="id"&&JSON.parse(e[2])>=d.queueID&&(d.queueID=JSON.parse(e[2])+1);return b=d.queueID,d.queueID++,b},g.recoverOlderJobObject=function(){var a=d.localStorage.getAll(),b="key",c=["splitedkey"];for(b in a)c=b.split("/"),c[0]==="jio"&&c[1]==="id"&&a[b]<Date.now()-1e4&&(d.localStorage.deleteItem(b),h.recoveredJobObject=d.localStorage.getItem("jio/jioObject/"+c[2]),d.localStorage.deleteItem("jio/jobObject/"+c[2]))},g.isThereJobsWhere=function(a){var b="id";if(!a)return!0;for(b in h.jobObject)if(a(h.jobObject[b]))return!0;return!1},g.copyJobQueueToLocalStorage=function(){return h.useLocalStorage?d.localStorage.setItem(h.jobObjectName,h.jobObject):!1},g.createJob=function(a){return g.addJob(new f(a))},g.addJob=function(a){var b={newone:!0,elimArray:[],waitArray:[],removeArray:[]},c=null,e="id";for(e in h.jobObject)if(d.jobManagingMethod.canSelect(h.jobObject[e],a)){if(d.jobManagingMethod.canRemoveFailOrDone(h.jobObject[e],a)){b.removeArray.push(e);continue}if(d.jobManagingMethod.canEliminate(h.jobObject[e],a)){b.elimArray.push(e);continue}if(d.jobManagingMethod.canReplace(h.jobObject[e],a)){c=new j({queue:g,job:h.jobObject[e]}),c.replace(a),b.newone=!1;break}if(d.jobManagingMethod.cannotAccept(h.jobObject[e],a))return!1;if(d.jobManagingMethod.mustWait(h.jobObject[e],a)){b.waitArray.push(e);continue}}if(b.newone){for(e in b.elimArray)c=new j({queue:g,job:h.jobObject[b.elimArray[e]]}),c.eliminate();if(b.waitArray.length>0){a.status="wait",a.waitingFor={jobIdArray:b.waitArray};for(e in b.waitArray)h.jobObject[b.waitArray[e]]&&(h.jobObject[b.waitArray[e]].maxtries=1)}for(e in b.removeArray)g.removeJob(h.jobObject[b.removeArray[e]]);a.id=h.jobid,a.tries=0,h.jobid++,h.jobObject[a.id]=a}return g.copyJobQueueToLocalStorage(),!0},g.removeJob=function(a){var c=b.extend({where:function(a){return!0}},a),d,e=!1,f="key";if(c.job)h.jobObject[c.job.id]&&c.where(h.jobObject[c.job.id])&&(delete h.jobObject[c.job.id],e=!0);else for(f in h.jobObject)c.where(h.jobObject[f])&&(delete h.jobObject[f],e=!0);e||b.error("No jobs was found, when trying to remove some."),g.copyJobQueueToLocalStorage()},g.resetAll=function(){var a="id";for(a in h.jobObject)h.jobObject[a].status="initial";g.copyJobQueueToLocalStorage()},g.invokeAll=function(){var a="id",b;for(a in h.jobObject){b=!1;if(h.jobObject[a].status==="initial")g.invoke(h.jobObject[a]);else if(h.jobObject[a].status==="wait"){b=!0;if(h.jobObject[a].waitingFor.jobIdArray)for(var c in h.jobObject[a].waitingFor.jobIdArray)if(h.jobObject[h.jobObject[a].waitingFor.jobIdArray[c]]){b=!1;break}h.jobObject[a].waitingFor.time&&h.jobObject[a].waitingFor.time>Date.now()&&(b=!1),b&&g.invoke(h.jobObject[a])}}this.copyJobQueueToLocalStorage()},g.invoke=function(a){var b;if(!c.jobMethodObject[a.method])return!1;g.isThereJobsWhere(function(b){return b.method===a.method&&b.method==="initial"})?a.status="ongoing":(a.status="ongoing",h.publisher.publish(c.jobMethodObject[a.method].start_event)),b=new j({queue:this,job:a}),b.execute()},g.ended=function(a){switch(a.status){case"done":g.removeJob({job:a});break;case"fail":g.copyJobQueueToLocalStorage();break;case"wait":break;default:}if(!c.jobMethodObject[a.method])return!1;if(!g.isThereJobsWhere(function(b){return b.method===a.method&&b.status==="ongoing"||b.status==="initial"})){h.publisher.publish(c.jobMethodObject[a.method].stop_event);return}},g.clean=function(){g.removeJob(undefined,{where:function(a){return a.status==="fail"}})},h.useLocalStorage=e.useLocalStorage,h.publisher=a,h.jobid=1,h.jioID=0,h.jobObjectName="",h.jobObject={},h.recoveredJobObject={},g},h=function(a){var b={},c={};return c.interval=200,c.id=null,c.queue=a,b.setIntervalDelay=function(a){c.interval=a},b.start=function(){return c.id?!1:(c.id=setInterval(function(){c.queue.recoverOlderJobObject(),c.queue.invokeAll()},c.interval),!0)},b.stop=function(){return c.id?(clearInterval(c.id),c.id=null,!0):!1},b},i=function(){var a={},b={};return b.interval=400,b.id=null,a.start=function(c){return b.id?!1:(a.touch(c),b.id=setInterval(function(){a.touch(c)},b.interval),!0)},a.stop=function(){return b.id?(clearInterval(b.id),b.id=null,!0):!1},a.touch=function(a){d.localStorage.setItem("jio/id/"+a,Date.now())},a},j=function(a){var c={},e={};return e.job=a.job,e.callback=a.job.callback,e.queue=a.queue,e.res={status:"done",message:""},e.fail_checkNameAvailability=function(){e.res.isAvailable=!1},e.done_checkNameAvailability=function(a){e.res.message=e.job.userName+" is "+(a?"":"not ")+"available.",e.res.isAvailable=a},e.fail_loadDocument=function(){e.res.document={}},e.done_loadDocument=function(a){e.res.message="Document loaded.",e.res.document=a,e.res.document.lastModified=(new Date(e.res.document.lastModified)).getTime(),e.res.document.creationDate=(new Date(e.res.document.creationDate)).getTime()},e.fail_saveDocument=function(){e.res.isSaved=!1},e.done_saveDocument=function(){e.res.message="Document saved.",e.res.isSaved=!0},e.fail_getDocumentList=function(){e.res.list=[]},e.done_getDocumentList=function(a){var b;e.res.message="Document list received.",e.res.list=a;for(b in e.res.list)e.res.list[b].lastModified=(new Date(e.res.list[b].lastModified)).getTime(),e.res.list[b].creationDate=(new Date(e.res.list[b].creationDate)).getTime()},e.fail_removeDocument=function(){e.res.isRemoved=!1},e.done_removeDocument=function(){e.res.message="Document removed.",e.res.isRemoved=!0},e.retryLater=function(){e.job.status="wait",e.job.waitingFor={time:Date.now()+e.job.tries*e.job.tries*1e3}},c.cloneJob=function(){return b.extend({},e.job)},c.getUserName=function(){return e.job.userName||""},c.getApplicantID=function(){return e.job.applicant.ID||""},c.getStorageUserName=function(){return e.job.storage.userName||""},c.getStoragePassword=function(){return e.job.storage.password||""},c.getStorageLocation=function(){return e.job.storage.location||""},c.getStorageArray=function(){return e.job.storage.storageArray||[]},c.getFileName=function(){return e.job.fileName||""},c.getFileContent=function(){return e.job.fileContent||""},c.cloneOptionObject=function(){return b.extend({},e.job.options)},c.getMaxTries=function(){return e.job.maxtries},c.getTries=function(){return e.job.tries||0},c.setMaxTries=function(a){e.job.maxtries=a},c.addJob=function(a){return e.queue.createJob(a)},c.eliminate=function(){e.job.maxtries=1,e.job.tries=1,c.fail("Job Stopped!",0)},c.replace=function(a){e.job.tries=0,e.job.date=a.date,e.job.callback=a.callback,e.res.status="fail",e.res.message="Job Stopped!",e.res.errno=0,e["fail_"+e.job.method](),e.callback(e.res)},c.fail=function(a,b){e.res.status="fail",e.res.message=a,e.res.errno=b,!e.job.maxtries||e.job.tries<e.job.maxtries?e.retryLater():(e.job.status="fail",e["fail_"+e.job.method](),e.queue.ended(e.job),e.callback(e.res))},c.done=function(a){e.job.status="done",e["done_"+e.job.method](a),e.queue.ended(e.job),e.callback(e.res)},c.execute=function(){return e.job.tries=c.getTries()+1,d.storageTypeObject[e.job.storage.type]?d.storageTypeObject[e.job.storage.type]({job:e.job,queue:e.queue})[e.job.method]():null},c.checkNameAvailability=function(){c.fail("This method must be redefined!",0)},c.loadDocument=function(){c.fail("This method must be redefined!",0)},c.saveDocument=function(){c.fail("This method must be redefined!",0)},c.getDocumentList=function(){c.fail("This method must be redefined!",0)},c.removeDocument=function(){c.fail("This method must be redefined!",0)},c},k=function(a,c,f){var j={},k={};j.getID=function(){return k.id},j.start=function(){return k.id!==0?!1:(k.id=k.queue.getNewQueueID(),k.queue.init({jioID:k.id}),k.updater&&k.updater.start(k.id),k.listener.start(),k.ready=!0,j.isReady())},j.stop=function(){return k.queue.close(),k.listener.stop(),k.updater&&k.updater.stop(),k.ready=!1,k.id=0,!0},j.kill=function(){return k.queue.close(),k.listener.stop(),k.updater&&k.updater.stop(),k.ready=!1,!0},j.isReady=function(){return k.ready},j.publish=function(a,b){if(!j.isReady())return;return k.pubsub.publish(a,b)},j.subscribe=function(a,b){return k.pubsub.subscribe(a,b)},j.unsubscribe=function(a,b){return k.pubsub.unsubscribe(a,b)},j.checkNameAvailability=function(a){var c=b.extend({userName:k.storage.userName,storage:k.storage,applicant:k.applicant,method:"checkNameAvailability",callback:function(){}},a);return j.isReady()&&c.userName&&c.storage&&c.applicant?k.queue.createJob(c):null},j.saveDocument=function(a){var c=b.extend({storage:k.storage,applicant:k.applicant,method:"saveDocument",callback:function(){}},a);return j.isReady()&&c.fileName&&c.fileContent&&c.storage&&c.applicant?k.queue.createJob(c):null},j.loadDocument=function(a){var c=b.extend({storage:k.storage,applicant:k.applicant,method:"loadDocument",callback:function(){}},a);return j.isReady()&&c.fileName&&c.storage&&c.applicant?k.queue.createJob(c):null},j.getDocumentList=function(a){var c=b.extend({storage:k.storage,applicant:k.applicant,method:"getDocumentList",callback:function(){}},a);return j.isReady()&&c.storage&&c.applicant?k.queue.createJob(c):null},j.removeDocument=function(a){var c=b.extend({storage:k.storage,applicant:k.applicant,method:"removeDocument",callback:function(){}},a);return j.isReady()&&c.fileName&&c.storage&&c.applicant?k.queue.createJob(c):null};var l=b.extend({useLocalStorage:!0},f);return typeof a=="string"&&(a=JSON.parse(f.storage)),typeof c=="string"&&(c=JSON.parse(f.applicant)),k.storage=a,k.applicant=c,k.id=0,k.pubsub=new e(l),k.queue=new g(k.pubsub,l),k.listener=new h(k.queue,l),k.ready=!1,l.useLocalStorage?k.updater=new i(l):k.updater=null,k.storage&&!d.storageTypeObject[k.storage.type]&&b.error('Unknown storage type "'+k.storage.type+'"'),j.start(),j},l=function(){var e={};return e.createNew=function(c,e,f){var g=b.extend({useLocalStorage:!0},f);return d.localStorage===null&&(d.localStorage=a),new k(c,e,g)},e.newBaseStorage=function(a){return new j(a)},e.addStorageType=function(a,b){return a&&b?(d.storageTypeObject[a]=b,!0):!1},e.getGlobalObject=function(){return d},e.getConstObject=function(){return b.extend({},c)},e},new l};return window.requirejs?(define("JIO",["LocalOrCookieStorage","jQuery"],a),undefined):a(LocalOrCookieStorage,jQuery)}();